<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">

	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="mobile-web-app-capable" content="yes">

	<title>FlappyJS</title>

	<script src="sprite.js"></script>

	<style>
	canvas {
		display: block;
		position: absolute;
		margin: auto;
		top: 0;
		bottom: 0;
		left: 0;
		right: 0;
	}
	</style>
</head>
<body>
<script>
    
    var
    canvas,
    ctx,
    width,
    height,
        
        
    frames = 0,
    score = 0,
    best = 0,
    fgpos = 0,
        
    currentstate,
    state = {
        Splash: 0, Game: 1, Score: 2
    },
        
    bird = {
        x: 80,
        y: 100,
        frame: 0,
        animation:[0,1,2,1],
        rotation: 0,
        gravity: 0.25,
        _jump: 4.6,
        velocity: 0,
        
        jump: function(){
            this.velocity = -this._jump;
        },
        
        update: function(){
            var n = currentstate === state.Splash ? 10 : 5;
            this.frame += frames % n === 0 ? 1 : 0;
            this.frame %=  this.animation.length;
            
            if(currentstate === state.Splash){
                this.y = height - 280 + 5*Math.cos(frames/10);
                this.rotation = 0;
            } else {
                this.velocity += this.gravity;
                this.y += this.velocity;
                
                if(this.y >= height - s_fg.height -10){
                    this.y = height - s_fg.height -10;
                    if(currentstate === state.Game){
                        currentstate = state.Score;
                    }
                    this.velocity = this._jump;
                }
                
                if(this.velocity >= this._jump){
                    this.frame = 1;
                    this.rotation = Math.sin(Math.PI/2, this.rotation + 0.3);
                } else {
                    this.rotation = -0.2;
                }
            }
        },
        
        draw: function(ctx){
            ctx.save();
            ctx.translate(this.x, this.y);
            ctx.rotate(this.rotation);
            
            var n = this.animation[this.frame];
            s_bird[n].draw(ctx, -s_bird[n].width/2, -s_bird[n].height/2);
            ctx.restore();
        }
    },
        
    pipes = {
        
        _pipes: [],
        
        reset: function(){
             this._pipes = [];
        },
        
        update: function(){
            if(frames % 100 === 0){
                var _y = height - (s_pipeSouth.height+s_fg.height+120+200*Math.random());
                this._pipes.push({
                    x: 500,
                    y: _y,
                    width: s_pipeSouth.width,
                    height: s_pipeNorth.height
                });
            }
            for(var i = 0, len = this._pipes.length; i < len; i++){
                var p = this._pipes[i];
                
                p.x -= 2;
                if(p.x < -50){
                    this._pipes.splice(i, 1);
                    i--;
                    len--;
                }
            }
        },
        
        draw: function(ctx){
            for(var i = 0, len = this._pipes.length; i < len; i++){
                var p = this._pipes[i];
                s_pipeSouth.draw(ctx, p.x, p.y);
                s_pipeNorth.draw(ctx, p.x, p.y+80+p.height);
            }
        }
    };
    
    function onpress(evt){
        switch(currentstate){
            case state.Splash:
                currentstate = state.Game;
                bird.jump();
                break;
            case state.Game:
                bird.jump();
                break;
            case state.Score:
                break;
        }
    }
    
    function main(){
        canvas = document.createElement("canvas");
        
        width = window.innerWidth;
        height = window.innerHeight;
        
        var evt = "touchstart";
        
        if(width >= 500){
            width = 320;
            height = 480;
            canvas.style.border = "1px solid #000";
            evt = "mousedown";
        }
        
        document.addEventListener(evt, onpress);
        
        canvas.width = width;
        canvas.height = height;
        ctx = canvas.getContext("2d");
        
        currentstate = state.Splash;
        
        document.body.appendChild(canvas);
        
        var img = new Image();
        img.onload = function(){
            //console.log("test");
            initSprites(this);
            ctx.fillStyle = s_bg.color;
            run();
        }
        img.src = "res/sheet.png";
    }
    
    function run(){
        var loop = function(){
            update();
            render();
            window.requestAnimationFrame(loop, canvas);
        }
        window.requestAnimationFrame(loop, canvas);
    }
    
    function update(){
        
        frames++;
        
        if(currentstate !== state.Score){
            fgpos = (fgpos - 2) % 14;
        }
        
        if(currentstate === state.Game){
            pipes.update();
        }
        
        //update the foreground position by incrementing the fgpos value
        //fgpos = (fgpos - 2) % 14;
        
        bird.update();
        
    }
    
    function render(){
        ctx.fillRect(0, 0, width, height);
        //backgroung
        s_bg.draw(ctx, 0, height - s_bg.height);
        s_bg.draw(ctx, s_bg.width, height - s_bg.height);
        
        //foreground
        s_fg.draw(ctx, fgpos, height - s_fg.height);
        s_fg.draw(ctx, fgpos+s_fg.width, height - s_fg.height);
        
        bird.draw(ctx);
        pipes.draw(ctx);
        
        var width2 = width/2;
        
        if(currentstate === state.Splash){
            s_splash.draw(ctx, width2 - s_splash.width/2, height - 300);
            s_text.GetReady.draw(ctx, width2 - s_text.GetReady.width/2, height - 380);
        }
    }
    
    main();

</script>
</body>
</html